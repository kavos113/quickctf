<div class="challenge-form-container">
  <div class="challenge-form-wrapper">
    <!-- å·¦å´ï¼šãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="challenge-form-card">
      <h1>{{ isEditMode() ? 'å•é¡Œã‚’ç·¨é›†' : 'æ–°è¦å•é¡Œä½œæˆ' }}</h1>

      <form (ngSubmit)="onSubmit()">
        @if (error()) {
        <div class="error-message">{{ error() }}</div>
        }

        <div class="form-group">
          <label for="name">å•é¡Œå <span class="required">*</span></label>
          <input type="text" id="name" name="name" [(ngModel)]="name" placeholder="å•é¡Œåã‚’å…¥åŠ›" [disabled]="isLoading()" />
        </div>

        <div class="form-group">
          <label for="genre">ã‚¸ãƒ£ãƒ³ãƒ« <span class="required">*</span></label>
          <input type="text" id="genre" name="genre" [(ngModel)]="genre" placeholder="ä¾‹: Web, Crypto, Pwn, Rev, Misc"
            [disabled]="isLoading()" />
        </div>

        <div class="form-group">
          <label for="points">ãƒã‚¤ãƒ³ãƒˆ <span class="required">*</span></label>
          <input type="number" id="points" name="points" [(ngModel)]="points" min="1" [disabled]="isLoading()" />
        </div>

        <div class="form-group">
          <label for="flag">ãƒ•ãƒ©ã‚° <span class="required">*</span></label>
          <input type="text" id="flag" name="flag" [(ngModel)]="flag" placeholder="ä¾‹: flag{example_flag}"
            [disabled]="isLoading()" />
        </div>

        <div class="form-group">
          <label for="description">èª¬æ˜ <span class="required">*</span></label>
          <textarea id="description" name="description" [(ngModel)]="description"
            placeholder="å•é¡Œã®èª¬æ˜ã‚’å…¥åŠ›ï¼ˆMarkdownã®ã‚ˆã†ãªè¨˜æ³•ãŒä½¿ãˆã¾ã™ï¼‰" rows="8" [disabled]="isLoading()"></textarea>
        </div>

        <div class="form-group">
          <label for="imageFile">å•é¡Œã‚¤ãƒ¡ãƒ¼ã‚¸ (tar)</label>
          <div class="file-upload-wrapper">
            <input type="file" id="imageFile" accept=".tar,.tar.gz,.tgz" (change)="onFileSelected($event)"
              [disabled]="isLoading()" />
            <div class="file-upload-area" [class.has-file]="selectedFile()">
              @if (selectedFile()) {
              <span class="file-name">ğŸ“¦ {{ selectedFile()?.name }}</span>
              <button type="button" class="remove-file" (click)="removeFile()">âœ•</button>
              } @else {
              <span class="upload-text">ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§tarãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</span>
              }
            </div>
          </div>
          @if (uploadProgress() > 0 && uploadProgress() < 100) { <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="uploadProgress()"></div>
        </div>
        }
    </div>

    @if (isEditMode()) {
    <div class="form-group">
      <label for="attachmentFile">æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</label>
      @if (attachments().length > 0) {
      <div class="attachments-list">
        @for (attachment of attachments(); track attachment.attachmentId) {
        <div class="attachment-item">
          <span class="attachment-icon">ğŸ“</span>
          <a [href]="attachment.url" target="_blank" class="attachment-name">{{
            attachment.filename
            }}</a>
          <span class="attachment-size">({{ formatFileSize(attachment.size) }})</span>
          <button type="button" class="attachment-delete" (click)="deleteAttachment(attachment.attachmentId)"
            [disabled]="isLoading()">
            ğŸ—‘ï¸
          </button>
        </div>
        }
      </div>
      }
      <div class="attachment-upload">
        <input type="file" id="attachmentFile" (change)="onAttachmentFileSelected($event)"
          [disabled]="isLoading() || isUploadingAttachment()" />
        @if (selectedAttachmentFile()) {
        <div class="selected-attachment">
          <span>{{ selectedAttachmentFile()?.name }}</span>
          <button type="button" class="remove-file" (click)="removeAttachmentFile()">
            âœ•
          </button>
        </div>
        }
        <button type="button" class="btn-secondary btn-upload" (click)="uploadAttachment()"
          [disabled]="!selectedAttachmentFile() || isLoading() || isUploadingAttachment()">
          @if (isUploadingAttachment()) {
          <span>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</span>
          } @else {
          <span>æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</span>
          }
        </button>
      </div>
    </div>
    }

    <div class="button-group">
      <button type="button" class="btn-secondary" (click)="cancel()" [disabled]="isLoading()">
        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      </button>
      <button type="submit" class="btn-primary" [disabled]="isLoading()">
        @if (isLoading()) {
        <span>ä¿å­˜ä¸­...</span>
        } @else {
        <span>{{ isEditMode() ? 'æ›´æ–°' : 'ä½œæˆ' }}</span>
        }
      </button>
    </div>
    </form>
  </div>

  <!-- å³å´ï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
  <div class="challenge-preview-card">
    <h2>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>

    <div class="preview-content">
      <div class="preview-header">
        @if (genre) {
        <span class="preview-genre">{{ genre }}</span>
        }
        <h3 class="preview-name">{{ name || 'å•é¡Œå' }}</h3>
        <div class="preview-points">{{ points }} pts</div>
      </div>

      <div class="preview-description">
        <h4>èª¬æ˜</h4>
        <div class="preview-description-content">
          @if (description) {
          <p>{{ description }}</p>
          } @else {
          <p class="placeholder-text">å•é¡Œã®èª¬æ˜ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
          }
        </div>
      </div>

      @if (flag) {
      <div class="preview-flag">
        <h4>ãƒ•ãƒ©ã‚°</h4>
        <code>{{ flag }}</code>
      </div>
      }

      @if (selectedFile()) {
      <div class="preview-image">
        <h4>å•é¡Œã‚¤ãƒ¡ãƒ¼ã‚¸</h4>
        <div class="image-info">
          <span class="file-icon">ğŸ“¦</span>
          <span>{{ selectedFile()?.name }}</span>
          <span class="file-size">({{ formatFileSize(selectedFile()?.size || 0) }})</span>
        </div>
      </div>
      }

      @if (attachments().length > 0) {
      <div class="preview-attachments">
        <h4>æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</h4>
        <ul>
          @for (attachment of attachments(); track attachment.attachmentId) {
          <li>ğŸ“ {{ attachment.filename }}</li>
          }
        </ul>
      </div>
      }
    </div>
  </div>
</div>
</div>